<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<title>Pregled proizvodnje</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#f6f8fb;
  --card:#ffffff;
  --primary:#6c63ff;
  --secondary:#00b894;
  --danger:#ff7675;
  --text:#2d3436;
  --muted:#636e72;
}

body{
  font-family: "Segoe UI", sans-serif;
  margin:10px;
  background:var(--bg);
  color:var(--text);
}

input,select,button{
  margin:4px;
  padding:8px 10px;
  border-radius:6px;
  border:1px solid #dcdde1;
  font-size:14px;
}

button{
  background:var(--primary);
  color:#fff;
  border:none;
  cursor:pointer;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  background:var(--card);
}

th{
  background:var(--primary);
  color:#fff;
  padding:10px;
}

td{
  padding:8px;
  border-bottom:1px solid #eee;
}

button.danger{
  background:var(--danger);
}
</style>
</head>

<body>

<div class="filter">
  <select id="mesec"></select>
  <select id="godina"></select>
  <input placeholder="Filter komentar" id="filterKomentar">
  <button onclick="render()">Filtriraj</button>
  <input type="number" id="marza" step="0.1" value="90"> % mar≈æe
</div>

<div class="summary">
Zarada perioda: <span id="mesecZarada">0</span> |
Sapun potro≈°en: <span id="mesecSapun">0</span>
</div>

<div>
<input type="date" id="datum">
<input placeholder="Vazna" id="vazna">
<input type="number" placeholder="Cena vazne" id="cenaVazne">
<input type="number" placeholder="Grama≈æa vazne" id="gramaza">
<input type="number" placeholder="Ukupna te≈æina" id="ukTezina">
<input type="number" placeholder="Ostalo" id="ostalo">
<input placeholder="Komentar" id="komentar">
<button onclick="dodaj()">Dodaj</button>
</div>

<table>
<thead>
<tr>
<th>Datum</th><th>Vazna</th><th>Cena</th><th>Grama≈æa</th>
<th>Uk.te≈æ</th><th>Sapun</th><th>Ostalo</th>
<th>Ukupno</th><th>Prodajna</th><th>Zarada</th>
<th>Komentar</th><th></th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<!-- üî• FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyATddV2eWAhAN2gi6Y8uQTwqLf3pv4fyK8",
  authDomain: "pregled-proizvodnje.firebaseapp.com",
  projectId: "pregled-proizvodnje",
  storageBucket: "pregled-proizvodnje.appspot.com",
  messagingSenderId: "908385637795",
  appId: "1:908385637795:web:6ef03d4095bcc9beab3616"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let podaci = [];

async function ucitajPodatke(){
  podaci = [];
  const snap = await getDocs(collection(db, "proizvodnja"));
  snap.forEach(d => podaci.push({ id: d.id, ...d.data() }));
  initGodine();
  render();
}

window.dodaj = async function(){
  await addDoc(collection(db, "proizvodnja"), {
    datum: datum.value,
    vazna: vazna.value,
    cena: +cenaVazne.value || 0,
    gram: +gramaza.value || 0,
    uk: +ukTezina.value || 0,
    ost: +ostalo.value || 0,
    kom: komentar.value
  });
  ucitajPodatke();
}

window.obrisi = async function(id){
  await deleteDoc(doc(db, "proizvodnja", id));
  ucitajPodatke();
}

function initMeseci(){
  mesec.innerHTML="";
  ["01","02","03","04","05","06","07","08","09","10","11","12"]
    .forEach((x,i)=>{
      let o=document.createElement("option");
      o.value=x; o.text=i+1;
      mesec.appendChild(o);
    });
  mesec.value=new Date().getMonth()+1+"";
}

function initGodine(){
  godina.innerHTML="";
  let set=new Set(["2025", "2026"]);
  podaci.forEach(r=>{
    if(r.datum) set.add(r.datum.split("-")[0]);
  });
  [...set].sort().forEach(y=>{
    let o=document.createElement("option");
    o.value=o.text=y;
    godina.appendChild(o);
  });
}

window.render = function(){
  tabela.innerHTML="";
  let m=mesec.value;
  let g=godina.value;
  let marza=(+document.getElementById("marza").value||0)/100;

  let mz=0, ms=0;

  podaci.forEach(r=>{
    if(!r.datum) return;
    let [yy,mm]=r.datum.split("-");
    if(mm!==m||yy!==g) return;

    let sap=r.uk-r.gram;
    let ukup=r.cena+sap+r.ost;
    let prod=ukup*(1+marza);
    let zar=prod-ukup;

    mz+=zar; ms+=sap;

    tabela.innerHTML+=`
      <tr>
        <td>${r.datum}</td>
        <td>${r.vazna}</td>
        <td>${r.cena}</td>
        <td>${r.gram}</td>
        <td>${r.uk}</td>
        <td>${sap.toFixed(2)}</td>
        <td>${r.ost}</td>
        <td>${ukup.toFixed(2)}</td>
        <td>${prod.toFixed(2)}</td>
        <td>${zar.toFixed(2)}</td>
        <td>${r.kom}</td>
        <td><button onclick="obrisi('${r.id}')">X</button></td>
      </tr>`;
  });

  mesecZarada.textContent=mz.toFixed(2);
  mesecSapun.textContent=ms.toFixed(2);
}

initMeseci();
ucitajPodatke();
</script>

</body>
</html>
