<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<title>Pregled proizvodnje</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#f6f8fb;
  --card:#ffffff;
  --primary:#6c63ff;
  --danger:#ff7675;
  --text:#2d3436;
}

body{
  font-family:"Segoe UI",sans-serif;
  margin:10px;
  background:var(--bg);
  color:var(--text);
}

input,select,button{
  margin:4px;
  padding:10px;
  border-radius:6px;
  border:1px solid #dcdde1;
  font-size:16px;
}

button{
  background:var(--primary);
  color:#fff;
  border:none;
  cursor:pointer;
}

button.danger{background:var(--danger);}

/* ===== FILTER & FORMA ===== */
.filter,#forma{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}

/* ===== TABELA (DESKTOP) ===== */
.table-wrap{
  overflow-x:auto;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  background:#fff;
}

th{
  background:var(--primary);
  color:#fff;
  padding:10px;
}

td{
  padding:8px;
  border-bottom:1px solid #eee;
}

td button{
  padding:6px 8px;
  font-size:14px;
}

/* ===== CARD VIEW (MOBILE) ===== */
#cards{display:none;}

.card{
  background:#fff;
  border-radius:10px;
  padding:12px;
  margin:12px 0;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}

.card-header{
  display:flex;
  justify-content:space-between;
  font-weight:700;
  margin-bottom:6px;
}

.card-row{
  display:flex;
  justify-content:space-between;
  padding:2px 0;
}

.card-profit{
  font-weight:700;
  color:#2ecc71;
}

.card-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.card-actions button{
  flex:1;
  padding:12px;
  font-size:16px;
}

/* ===== MOBILE SWITCH ===== */
@media(max-width:768px){
  .table-wrap{display:none;}
  #cards{display:block;}
}
</style>
</head>

<body>

<div class="filter">
  <select id="mesec"></select>
  <select id="godina"></select>
  <input placeholder="Filter komentar" id="filterKomentar">
  <input type="number" id="marza" value="90"> % mar≈æe
  <button onclick="render()">Filtriraj</button>
</div>

<div class="summary">
  Zarada: <span id="mesecZarada">0</span> |
  Sapun: <span id="mesecSapun">0</span>
</div>

<div id="forma">
  <input type="date" id="datum">
  <input placeholder="Vazna" id="vazna">
  <input type="number" placeholder="Cena vazne" id="cenaVazne">
  <input type="number" placeholder="Grama≈æa vazne" id="gramaza">
  <input type="number" placeholder="Ukupna te≈æina" id="ukTezina">
  <input type="number" placeholder="Ostalo" id="ostalo">
  <input placeholder="Komentar" id="komentar">
  <button onclick="dodaj()">Dodaj</button>
</div>

<!-- DESKTOP TABELA -->
<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Datum</th><th>Vazna</th><th>Cena</th><th>Grama≈æa</th>
  <th>Uk.te≈æ</th><th>Sapun</th><th>Ostalo</th>
  <th>Ukupno</th><th>Prodajna</th><th>Zarada</th>
  <th>Komentar</th><th></th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>
</div>

<!-- MOBILE KARTICE -->
<div id="cards"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyATddV2eWAhAN2gi6Y8uQTwqLf3pv4fyK8",
  authDomain: "pregled-proizvodnje.firebaseapp.com",
  projectId: "pregled-proizvodnje",
  storageBucket: "pregled-proizvodnje.appspot.com",
  messagingSenderId: "908385637795",
  appId: "1:908385637795:web:6ef03d4095bcc9beab3616"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let podaci=[];

function formatDatum(d){
  if(!d) return "";
  let [y,m,dd]=d.split("-");
  return `${dd}/${m}/${y}`;
}

async function ucitajPodatke(){
  podaci=[];
  const snap=await getDocs(collection(db,"proizvodnja"));
  snap.forEach(d=>podaci.push({id:d.id,...d.data()}));
  initGodine();
  render();
}

window.dodaj = async function(){
  if(!datum.value) return;

  await addDoc(collection(db,"proizvodnja"),{
    datum: datum.value,
    vazna: vazna.value,
    cena: +cenaVazne.value||0,
    gram: +gramaza.value||0,
    uk: +ukTezina.value||0,
    ost: +ostalo.value||0,
    kom: komentar.value,
    prodajna: null,
    rucna: false
  });

  document.querySelectorAll("#forma input").forEach(i=>i.value="");
  ucitajPodatke();
}

window.obrisi = async function(id){
  await deleteDoc(doc(db,"proizvodnja",id));
  ucitajPodatke();
}

window.editRow = function(id){
  let r=podaci.find(x=>x.id===id);
  let nova=prompt("Unesi prodajnu cenu:",r.prodajna??"");
  if(nova===null) return;
  nova=+nova;
  if(isNaN(nova)) return;
  updateDoc(doc(db,"proizvodnja",id),{prodajna:nova,rucna:true})
    .then(ucitajPodatke);
}

function initMeseci(){
  mesec.innerHTML=`<option value="">Svi meseci</option>`;
  ["01","02","03","04","05","06","07","08","09","10","11","12"]
    .forEach((x,i)=>mesec.innerHTML+=`<option value="${x}">${i+1}</option>`);
}

function initGodine(){
  godina.innerHTML=`<option value="">Sve godine</option>`;
  let s=new Set();
  podaci.forEach(r=>r.datum&&s.add(r.datum.split("-")[0]));
  [...s].sort().forEach(y=>godina.innerHTML+=`<option>${y}</option>`);
}

window.render=function(){
  tabela.innerHTML="";
  cards.innerHTML="";

  let marza=(+marza.value||0)/100;
  let m=mesec.value, g=godina.value;
  let fk=filterKomentar.value.toLowerCase();

  let mz=0, ms=0;

  podaci.forEach(r=>{
    if(!r.datum) return;
    let [yy,mm]=r.datum.split("-");
    if(m && mm!==m) return;
    if(g && yy!==g) return;
    if(fk && !(r.kom||"").toLowerCase().includes(fk)) return;

    let sap=r.uk-r.gram;
    let ukup,prod,zar;

    if((r.vazna||"").toLowerCase()==="patuljak"){
      ukup=sap+r.ost;
      prod=ukup*(1+marza);
    }else{
      ukup=r.cena+sap+r.ost;
      prod=(r.rucna&&r.prodajna)?r.prodajna:ukup*(1+marza);
    }
    zar=prod-ukup;
    mz+=zar; ms+=sap;

    tabela.innerHTML+=`
      <tr>
        <td>${formatDatum(r.datum)}</td>
        <td>${r.vazna}</td>
        <td>${r.cena}</td>
        <td>${r.gram}</td>
        <td>${r.uk}</td>
        <td>${sap.toFixed(2)}</td>
        <td>${r.ost}</td>
        <td>${ukup.toFixed(2)}</td>
        <td>${prod.toFixed(2)}</td>
        <td>${zar.toFixed(2)}</td>
        <td>${r.kom||""}</td>
        <td>
          <button onclick="editRow('${r.id}')">‚úèÔ∏è</button>
          <button class="danger" onclick="obrisi('${r.id}')">‚ùå</button>
        </td>
      </tr>`;

    cards.innerHTML+=`
      <div class="card">
        <div class="card-header">
          <span>${formatDatum(r.datum)}</span>
          <span>${r.vazna}</span>
        </div>
        <div class="card-row"><span>Sapun</span><span>${sap.toFixed(2)}</span></div>
        <div class="card-row"><span>Ostalo</span><span>${r.ost}</span></div>
        <div class="card-row"><span>Ukupno</span><span>${ukup.toFixed(2)}</span></div>
        <div class="card-row"><span>Prodajna</span><span>${prod.toFixed(2)}</span></div>
        <div class="card-row card-profit"><span>Zarada</span><span>${zar.toFixed(2)}</span></div>
        ${r.kom?`<div style="margin-top:6px">üí¨ ${r.kom}</div>`:""}
        <div class="card-actions">
          <button onclick="editRow('${r.id}')">‚úèÔ∏è Izmeni</button>
          <button class="danger" onclick="obrisi('${r.id}')">‚ùå Obri≈°i</button>
        </div>
      </div>`;
  });

  mesecZarada.textContent=mz.toFixed(2);
  mesecSapun.textContent=ms.toFixed(2);
}

initMeseci();
ucitajPodatke();
</script>

</body>
</html>
