<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Pregled proizvodnje</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6c63ff">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#f6f8fb;
  --card:#ffffff;
  --primary:#6c63ff;
  --danger:#ff7675;
  --text:#2d3436;
}

body{
  font-family:"Segoe UI",sans-serif;
  margin:10px;
  background:var(--bg);
  color:var(--text);
}

input,select,button{
  margin:4px;
  padding:8px 10px;
  border-radius:6px;
  border:1px solid #dcdde1;
  font-size:14px;
}

button{
  background:var(--primary);
  color:#fff;
  border:none;
  cursor:pointer;
}

button.danger{background:var(--danger);}

.filter, #forma{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}

.summary{
  margin:10px 0;
  font-weight:600;
}

.table-wrap{
  width:100%;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}

table{
  width:100%;
  min-width:1200px;
  border-collapse:collapse;
  margin-top:10px;
  background:var(--card);
}

th{
  background:var(--primary);
  color:#fff;
  padding:10px;
  white-space:nowrap;
}

td{
  padding:8px;
  border-bottom:1px solid #eee;
  white-space:nowrap;
}

td button{
  margin:0 2px;
  padding:4px 6px;
}

@media (max-width:768px){
  .filter, #forma{flex-direction:column;}
  input,select,button{width:100%;font-size:16px;}
  td button{min-width:38px;min-height:38px;}
}
</style>
</head>

<body>

<div class="filter">
  <select id="mesec"></select>
  <select id="godina"></select>
  <input id="filterKomentar" placeholder="Filter komentar">
  <button onclick="render()">Filtriraj</button>
  <input type="number" id="marza" value="90" step="0.1"> % marže
</div>

<div class="summary">
  Zarada: <span id="mesecZarada">0</span> |
  Sapun: <span id="mesecSapun">0</span>
</div>

<div id="forma">
  <input type="date" id="datum">
  <input id="vazna" placeholder="Vazna">
  <input type="number" id="cenaVazne" placeholder="Cena vazne">
  <input type="number" id="gramaza" placeholder="Gramaža vazne">
  <input type="number" id="ukTezina" placeholder="Ukupna težina">
  <input type="number" id="ostalo" placeholder="Ostalo">
  <input id="komentar" placeholder="Komentar">
  <button id="btnDodaj" onclick="dodaj()">Dodaj</button>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Datum</th><th>Vazna</th><th>Cena</th><th>Gramaža</th>
  <th>Uk.tež</th><th>Sapun</th><th>Ostalo</th>
  <th>Ukupno</th><th>Prodajna</th><th>Zarada</th>
  <th>Komentar</th><th></th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyATddV2eWAhAN2gi6Y8uQTwqLf3pv4fyK8",
  authDomain: "pregled-proizvodnje.firebaseapp.com",
  projectId: "pregled-proizvodnje",
  storageBucket: "pregled-proizvodnje.appspot.com",
  messagingSenderId: "908385637795",
  appId: "1:908385637795:web:6ef03d4095bcc9beab3616"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let podaci=[];

async function ucitajPodatke(){
  podaci=[];
  const snap=await getDocs(collection(db,"proizvodnja"));
  snap.forEach(d=>podaci.push({id:d.id,...d.data()}));
  initGodine();
  render();
}

window.dodaj = async function(){
  if(!datum.value) return;

  await addDoc(collection(db,"proizvodnja"),{
    datum:datum.value,
    vazna:vazna.value,
    cena:+cenaVazne.value||0,
    gram:+gramaza.value||0,
    uk:+ukTezina.value||0,
    ost:+ostalo.value||0,
    kom:komentar.value,
    prodajna:null,
    rucna:false
  });

  forma.querySelectorAll("input").forEach(i=>i.value="");
  datum.focus();
  ucitajPodatke();
}

window.obrisi = async id=>{
  await deleteDoc(doc(db,"proizvodnja",id));
  ucitajPodatke();
};

/* ENTER NAVIGACIJA – FINAL FIX */
const inputs=[datum,vazna,cenaVazne,gramaza,ukTezina,ostalo,komentar];
inputs.forEach((inp,i)=>{
  inp.addEventListener("keydown",e=>{
    if(e.key==="Enter"){
      e.preventDefault();
      if(i<inputs.length-1) inputs[i+1].focus();
      else document.getElementById("btnDodaj").click();
    }
  });
});

function formatDatum(d){
  if(!d) return "";
  let [y,m,da]=d.split("-");
  return `${da}/${m}/${y}`;
}

function initMeseci(){
  mesec.innerHTML=`<option value="">Svi meseci</option>`;
  ["01","02","03","04","05","06","07","08","09","10","11","12"]
  .forEach((x,i)=>mesec.innerHTML+=`<option value="${x}">${i+1}</option>`);
}

function initGodine(){
  godina.innerHTML=`<option value="">Sve godine</option>`;
  let set=new Set();
  podaci.forEach(r=>r.datum&&set.add(r.datum.split("-")[0]));
  [...set].sort().forEach(y=>godina.innerHTML+=`<option>${y}</option>`);
}

window.editRow=id=>{
  let r=podaci.find(x=>x.id===id);
  let c=prompt("Unesi prodajnu cenu:",r.prodajna??"");
  if(c===null||isNaN(+c)) return;
  updateDoc(doc(db,"proizvodnja",id),{prodajna:+c,rucna:true})
  .then(ucitajPodatke);
};

window.render=function(){
  tabela.innerHTML="";
  let m=mesec.value,g=godina.value;
  let marza=(+marzaInput.value||0)/100;
  let fk=filterKomentar.value.toLowerCase();
  let mz=0,ms=0;

  podaci.forEach(r=>{
    if(!r.datum) return;
    let [yy,mm]=r.datum.split("-");
    if(m&&mm!==m) return;
    if(g&&yy!==g) return;
    if(fk&&!((r.kom||"").toLowerCase().includes(fk))) return;

    let sap=r.uk-r.gram;
    let ukup=r.cena+sap+r.ost;
    let prod=(r.rucna&&r.prodajna)?r.prodajna:ukup*(1+marza);
    let zar=prod-ukup;

    mz+=zar; ms+=sap;

    tabela.innerHTML+=`
    <tr>
      <td>${formatDatum(r.datum)}</td>
      <td>${r.vazna}</td>
      <td>${r.cena}</td>
      <td>${r.gram}</td>
      <td>${r.uk}</td>
      <td>${sap.toFixed(2)}</td>
      <td>${r.ost}</td>
      <td>${ukup.toFixed(2)}</td>
      <td>${prod.toFixed(2)}</td>
      <td>${zar.toFixed(2)}</td>
      <td>${r.kom||""}</td>
      <td>
        <button onclick="editRow('${r.id}')">✏️</button>
        <button class="danger" onclick="obrisi('${r.id}')">❌</button>
      </td>
    </tr>`;
  });

  mesecZarada.textContent=mz.toFixed(2);
  mesecSapun.textContent=ms.toFixed(2);
}

const marzaInput=document.getElementById("marza");
initMeseci();
ucitajPodatke();
</script>

</body>
</html>
